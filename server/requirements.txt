from fastapi import FastAPI, UploadFile, File, Form
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

from .catalog import init_db, get_bucket
from .session import create_session
from .kpir import compute_masked_dot
from .loader import CHUNKS
from .admin import handle_upload

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

init_db()

class SessionRequest(BaseModel):
    ghost_id: str

class KpirRequest(BaseModel):
    subset_ids: list[int]
    masked_vector: list[int]
    chunk_index: int

@app.post("/session")
def session(request: SessionRequest):
    token = create_session(request.ghost_id)
    return {"token": token}

@app.get("/catalog")
def catalog(topic: str = None, tier: int = None):
    modules = get_bucket(topic, tier)
    return {"modules": modules}

@app.post("/kpir")
def kpir(request: KpirRequest):
    matrix = []

    for module_id in request.subset_ids:
        matrix.append(
            CHUNKS[module_id][request.chunk_index]
        )

    result = compute_masked_dot(
        request.masked_vector,
        matrix
    )

    return {"data": result}

@app.post("/admin/upload")
async def upload_module(
    title: str = Form(...),
    topic: str = Form(...),
    tier: int = Form(...),
    file: UploadFile = File(...)
):
    module_id = handle_upload(file, title, topic, tier)
    return {"status": "uploaded", "module_id": module_id}